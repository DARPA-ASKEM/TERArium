---
# Automatically build Docker images on changes to main and push them to a
# Container Registry using HCL Bake file.

name: Build and Publish

on:
  push:
    branches: ['main']
    tags: ['*']

env:
  REGISTRY: ghcr.io
  ORG: ${{ github.repository_owner }}
  BAKE_FILE: docker-bake.hcl
  BAKE_GROUP: prod

jobs:
  # Run Global Lint
  lint:
    uses: ./.github/workflows/lint.yml

  # Lint Client Code
  lint-client:
    uses: ./.github/workflows/lint-client.yml

  # Run Client Tests
  test-client:
    uses: ./.github/workflows/test-client.yml

  # Generate a more robust tag for the image
  tag-generator:
    name: Determine image tag
    runs-on: ubuntu-22.04
    outputs:
      image-tag: ${{ steps.generate.outputs.tag }}
    steps:
      - name: Generate apprropriate tag
        id: generate
        run: |
          if [[ '${{ github.ref_type }}' == 'branch' && '${{ github.ref_name }}' == 'main' ]]; then
            TAG=latest
          else
            SEMVER=$( echo ${{ github.ref_name }} | sed -nre 's/^v[^0-9]*(([0-9]+\.)*[0-9]+(-[a-z]+)?).*/\1/p')
            if [[ -n $SEMVER ]]; then
              TAG=${SEMVER}
            else
              TAG=${{ github.ref_name }}
            fi
          fi

          echo "$TAG"
          echo "tag=${TAG,,}" >> ${GITHUB_OUTPUT}

      - name: Show Generated Tag
        run: echo ${{ steps.generate.outputs.tag }}

  # Build and Publish all targets associated with specified group
  bake:
    needs:
      - lint
      - lint-client
      - test-client
      - tag-generator
    uses: darpa-askem/.github/.github/workflows/bake-publish.yml@main
    with:
      file: '${BAKE_FILE}'
      group: '${BAKE_GROUP}'
      registry: '${REGISTRY}'
      organization: '${ORG}'
      tag: ${{ needs.tag-generator.outputs.image-tag }}
    secrets:
      username: ${{ github.repository_owner }}
      password: ${{ secrets.GITHUB_TOKEN }}
